{% extends "transcriptions/base.html" %}

{% load staticfiles %}

{% load concordia_media_tags %}

{% block title %}
Crowd: {{ asset.title }} ({{ asset.item.project.campaign.title }} — {{ asset.item.project.title }})
{% endblock title %}

{% block head_content %}
{% endblock head_content %}

{% block breadcrumbs %}
    <li class="breadcrumb-item"><a class="primary-text" href="{% url 'transcriptions:campaign' slug=campaign.slug %}">{{ campaign.title }}</a></li>
    <li class="breadcrumb-item"><a class="primary-text" href="{% url 'transcriptions:project-detail' campaign_slug=campaign.slug slug=project.slug %}">{{ project.title }}</a></li>
    <li class="breadcrumb-item"><a class="primary-text" href="{% url 'transcriptions:item-detail' campaign_slug=campaign.slug project_slug=project.slug item_id=item.item_id %}">{{ item.title }}</a></li>
    <li class="breadcrumb-item active">{{ asset.title }}</li>
{% endblock breadcrumbs %}

{% block extra_body_classes %}d-flex flex-column{% endblock %}
{% block extra_main_classes %}flex-grow-1 d-flex flex-column{% endblock %}

{% block main_content %}
<div id="contribute-main-content" class="container-fluid flex-grow-1 d-flex flex-column">
    <div id="navigation-container" class="row py-2">
        <nav id="asset-navigation" class="d-flex flex-grow-1 justify-content-between align-items-center" role="navigation">
            <div class="d-flex align-items-center">
                <form onsubmit="document.location.href = document.getElementById('asset-selection').value; return false">
                    <div class="input-group input-group-sm">
                        <div class="input-group-prepend">
                            <label class="input-group-text" for="asset-selection">Page</a>
                        </div>
                        <select id="asset-selection" class="custom-select custom-select-sm">
                            {% for sequence, slug in asset_navigation %}
                                <option {% if sequence == asset.sequence %}selected{% endif %} value="{% url 'transcriptions:asset-detail' campaign.slug project.slug item.item_id slug %}">{{ sequence }}</option>
                            {% endfor %}
                        </select>
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-outline-default">Go</button>
                        </div>
                    </div>
                </form>

                <div class="btn-group btn-group-sm ml-2">
                    <a class="btn btn-default {% if not previous_asset_url %}disabled{% endif %}" {% if previous_asset_url %}href="{{ previous_asset_url }}"{% else %}aria-disabled="true"{% endif %}>
                        <span class="fas fa-chevron-left"></span>
                        <span class="sr-only">Previous Page</span>
                    </a>
                    <a class="btn btn-default {% if not next_asset_url %}disabled{% endif %}" {% if next_asset_url %}href="{{ next_asset_url }}"{% else %}aria-disabled="true"{% endif %}>
                        <span class="fas fa-chevron-right"></span>
                        <span class="sr-only">Next Page</span>
                    </a>
                </div>
            </div>

            <div class="btn-group btn-group-sm align-self-end" role="navigation" aria-label="Link to the next editable page">
                <a class="btn btn-default" href="{% url "transcriptions:redirect-to-next-transcribable-asset" campaign.slug project.slug %}">Find a new page &rarr;</a>
            </div>
        </nav>
    </div>
    <div id="contribute-container" class="row flex-grow-1 pb-2">
        <div class="col-6">
            <div id="asset-image" class="h-100 bg-dark"></div>
        </div>

        <div class="col-6 d-flex flex-column flex-nowrap justify-content-between">
            <div class="flex-grow-1 d-flex flex-column">
                <div class="tx-status-display">
                    <span class="tx-submitted" {% if transcription_status != 'submitted' %}hidden{% endif %}>
                        <span class="fas fa-list"></span>
                        Submitted for Review
                    </span>
                    <span class="tx-completed" {% if transcription_status != 'completed' %}hidden{% endif %}>
                        <span class="fas fa-check"></span>
                        Completed
                    </span>
                    <span class="tx-edit" {% if transcription_status != "edit" %}hidden{% endif %}>
                        <span class="fas fa-edit"></span>
                        Open for edit
                    </span>
                    <span class="tx-edit-conflict" hidden>
                        <span class="fas fa-exclamation-triangle"></span>
                        Another user is transcribing this page
                    </span>
                </div>

                <form id="transcription-editor" class="ajax-submission flex-grow-1 d-flex flex-column" method="post" action="{% url 'save-transcription' asset_pk=asset.pk %}" data-transcription-status="{{ transcription_status }}" {% if transcription %}data-transcription-id="{{ transcription.pk|default:'' }}" {% if transcription.submitted %}data-unsaved-changes="true"{% endif %} data-submit-url="{% url 'submit-transcription' pk=transcription.pk %}" data-review-url="{% url 'review-transcription' pk=transcription.pk %}"{% endif %}>
                    {% csrf_token %}
                    <input type="hidden" name="supersedes" value="{{ transcription.pk|default:'' }}" />

                    <h2>Transcription</h2>

                    {% spaceless %}
                        <textarea readonly class="form-control w-100 rounded flex-grow-1" name="text" id="transcription-input" placeholder="Go ahead, start typing. You got this!" aria-label="Transcription input">
                            {{ transcription.text }}
                        </textarea>

                        {% if user.is_anonymous %}
                            <div class="d-none my-2 col-12 col-md-10 col-lg-8 mx-auto" id="captcha_container">
                                <div class="text-center mt-3" id="captcha_div">
                                    {{ captcha_form.captcha }}
                                </div>
                            </div>
                        {% endif %}

                        <div class="my-3 d-flex flex-wrap justify-content-around align-items-center btn-row">
                            {% if transcription_status == 'edit' %}
                                <div class="form-check w-100 text-center mt-0 mb-3">
                                    <input id="nothing-to-transcribe" type="checkbox" class="form-check-input" />
                                    <label class="form-check-label" for="nothing-to-transcribe">
                                        Nothing to transcribe
                                    </label>
                                </div>
                                <button id="save-transcription-button" disabled type="submit" class="btn btn-primary">Save</button>
                                <button id="submit-transcription-button" disabled type="button" class="btn btn-primary">Submit for Review</button>
                            {% elif transcription_status == 'submitted' and user.is_authenticated and transcription.user.pk != user.pk %}
                                <button id="reject-transcription-button" disabled type="button" class="btn btn-primary">Edit</button>
                                <button id="accept-transcription-button" disabled type="button" class="btn btn-primary">Accept</button>
                            {% endif %}
                        </div>
                    {% endspaceless %}
                </form>
            </div>
            <div id="tag-editor" class="flex-shrink-1 container">
                <form class="ajax-submission" method="post" action="{% url 'submit-tags' asset_pk=asset.pk %}">
                    {% csrf_token %}

                    <h2>Tags</h2>

                    {% if user.is_authenticated %}
                        <div class="form-row">
                            <div class="input-group">
                                <input type="text" id="new-tag-input" class="form-control" placeholder="Add a new tag…" aria-label="Add a new tag" pattern="[- _'\w]{1,50}">
                                <div class="input-group-append">
                                    <button id="new-tag-button" class="btn btn-outline-primary" type="button">Add</button>
                                </div>
                                <div class="invalid-feedback">
                                    Tags must be between 1-50 characters and may contain only letters, numbers, dashes, underscores, apostrophes, and spaces
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="help-text primary-text">
                            Only registered users can tag.
                            <a class="primary-text" href="/account/register/">Register</a> or <a class="primary-text" href="/account/login">Login</a>
                        </p>
                    {% endif %}

                    <ul id="current-tags" class="d-flex flex-wrap list-unstyled mb-0">
                        <li id="tag-template" hidden>
                            <label>
                                <input type="hidden" name="tags" value="" disabled />
                            </label>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </li>
                        {% for tag in tags %}
                            <li>
                                <label>
                                    <input type="hidden" name="tags" value="{{ tag }}" />
                                    {{ tag }}
                                </label>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </li>
                        {% endfor %}
                    </ul>

                    {% if user.is_authenticated %}
                        <div class="form-row btn-row">
                            <button id="save-tags-button" type="submit" class="btn btn-primary mx-auto">Save Tags</button>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    <div id="help-container" class="row justify-content-center">
        <p>Need help?</p>

        <button id="instruction-button" class="btn btn-secondary" type="button" data-toggle="collapse" data-target="#instruction-window" aria-expanded="false" aria-controls="instruction-window">
            Quick Tips
        </button>

        <a class="btn btn-secondary" href="{% url 'help-center' %}">
            Questions?
        </a>

        <div class="collapse" id="instruction-window">
            <button type="button" class="close pull-right" aria-label="Close" data-toggle="collapse" data-target="#instruction-window">
                <span aria-hidden="true">&times;</span>
            </button>
            <p>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
            </p>
        </div>
    </div>
    <div id="asset-reservation-failure-modal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Someone else is already transcribing this page</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>You can help by transcribing a new page, adding tags to this page, or coming back later to review this page's transcription.</p>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary" href="{% url "transcriptions:redirect-to-next-transcribable-asset" campaign.slug project.slug %}">
                        Find a new page
                    </a>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="successful-submission-modal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nice Job!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        This page has been submitted for review. You can
                        continue to add tags for this page or go to the next
                        page needing transcription.
                    </p>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary" href="{% url "transcriptions:redirect-to-next-transcribable-asset" campaign.slug project.slug %}">
                        Find a new page
                    </a>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">
                        Continue Tagging
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="successful-review-modal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nice Job!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        Your review decision has been saved. You can continue
                        workong on this page or go to the next page needing
                        transcription.
                    </p>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary" href="{% url "transcriptions:redirect-to-next-transcribable-asset" campaign.slug project.slug %}">
                        Find a new page
                    </a>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">
                        Continue Working
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block body_scripts %}
<script src="{% static 'vendor/openseadragon/openseadragon.min.js' %}"></script>
<script src="{% static 'js/contribute.js' %}"></script>
<script src="{% static 'js/asset-reservation.js' %}"></script>
<script type="text/javascript">
    var viewer = OpenSeadragon({
        id: 'asset-image',
        prefixUrl: '{% static "vendor/openseadragon/images/" %}',
        tileSources: {
            type: 'image',
            url: "{% asset_media_url asset %}"
        },
        showRotationControl: true,
        gestureSettingsTouch: {
            pinchRotate: true
        }
    });
</script>

{% if transcription_status == "edit" %}
    <script>
        attemptToReserveAsset("{% url 'reserve-asset-for-transcription' asset.pk %}");
    </script>
{% endif %}

{% endblock body_scripts %}
