{% extends "transcriptions/base.html" %}
{% block title %}Crowd â€” Campaigns{% endblock title %}
{% block main_content %} {% load staticfiles %}
{% load auth_extras %}

<div class="container-fluid py-default">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-offwhite">
            <li class="breadcrumb-item"><a class="primary-text" href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Campaigns</li>
        </ol>
    </nav>
    <div class="row">
        <div class="col-12">
            <div class="row">
                <div class="d-flex flex-wrap col-12 mb-default justify-content-around">
                    {% if response.results %}
                        {% if request.user.is_anonymous or request.user.is_staff is False %}
                            {% for c in response.results %}
                                {% if c.is_publish %}
                                    <div class="bg-lightest-gray w-100 mb-default">
                                        <div class="row">
                                            <div class="col-12 col-md-8 px-half">
                                                <a href="{% url 'transcriptions:campaign' c.slug %}">
                                                    <h1 class="campaign-title">{{ c.title }}</h1>
                                                    <p class="hero-text">{{ c.description }}</p>
                                                </a>
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <!-- TODO: Swap this out -->
                                                <img src="{% static "img/rosa-parks-campaign.svg" %}" class="img-fluid" alt="{{ c.title }} image">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-default">
                                        {% for project in projects %}
                                            {% if project.is_publish %}
                                                <div class="col-12 col-md-4 col-lg-3 mb-default mx-md-quarter">
                                                    <a href="{% url 'transcriptions:project' project.campaign.slug project.slug %}">
                                                        <!-- TODO: Swap this out -->
                                                        <img src="{% static "img/rosa-parks-campaign.svg" %}" class="img-fluid" alt="{{ project.title }} image">
                                                        <h4 class="">{{ project.title }}</h4>
                                                    </a>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% for c in response.results %}
                                <div class="bg-lightest-gray w-100 mb-default">
                                    <div class="row">
                                        <div class="col-12 col-md-8 px-half">
                                            <a href="{% url 'transcriptions:campaign' c.slug %}">
                                                <h1 class="campaign-title">{{ c.title }}</h1>
                                                <p class="hero-text">{{ c.description }}</p>
                                            </a>
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Admin tasks</button>
                                            <div class="dropdown-menu">
                                                <a href="{% url 'transcriptions:report campaign' c.slug %}" class="dropdown-item"> View Reports</a>
                                                <a href="{% url 'transcriptions:exportCSV campaign' c.slug %}" class="dropdown-item">Export to CSV</a>
                                                <a href="{% url 'transcriptions:exportBagit campaign' c.slug %}" class="dropdown-item">Export to Bagit</a>
                                                <a href="{% url 'transcriptions:delete campaign' c.slug %}" class="dropdown-item">Delete</a>
                                                {% if request.user|has_group:"CM" %}
                                                    <div role="separator" class="dropdown-divider"></div>
                                                    {% if c.is_publish %}
                                                        <a role="button" class="confirm-modal dropdown-item" data-toggle="modal" id="{{ c.slug }}" href="#campaignConfirmModal">Unpublish</a>
                                                    {% else %}
                                                        <a role="button" class="confirm-modal dropdown-item" data-toggle="modal" id="{{ c.slug }}" href="#campaignConfirmModal">Publish</a>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <a href="{% url 'transcriptions:campaign' c.slug %}">
                                                <!-- TODO: Swap this out -->
                                                <img src="{% static "img/rosa-parks-campaign.svg" %}" class="img-fluid" alt="{{ c.title }} image">
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-default">
                                    {% for project in projects %}
                                        <div class="col-12 col-md-4 col-lg-3 mb-default mx-md-quarter">
                                            <a href="{% url 'transcriptions:project' project.campaign.slug project.slug %}">
                                                <!-- TODO: Swap this out -->
                                                <img src="{% static "img/rosa-parks-campaign.svg" %}" class="img-fluid" alt="{{ project.title }} image">
                                                <h4 class="">{{ project.title }}</h4>
                                            </a>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                    {% if request.user.is_staff %}
                        <div class="col-12 col-md-4 col-lg-3 mb-default card shadow-regular bg-lightest-gray">
                            <a href="{% url 'transcriptions:create' %}">
                                <div class="d-flex card-body align-items-center justify-content-center">
                                    <span>Add new Campaign</span>
                                </div>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="campaignConfirmModal" tabindex="-1" role="dialog" aria-labelledby="campaignConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="campaignConfirmModalLabel">Confirm Campaign</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to make this campaign public?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="confirmbtn">Submit</button>
      </div>
    </div>
  </div>
</div>
{% endblock main_content %}

{% block body_scripts %}
<script>
    $(document).ready(function(){
         $(document).on('show.bs.modal',"#campaignConfirmModal", function (e) {
             var $invoker = $(e.relatedTarget);
             $("#confirmbtn").click(function(e){
                var campaign_slug = $($invoker[0]).attr('id');
                var requested_status = $("#"+campaign_slug).text().trim();
                if(requested_status == 'Publish'){
                    var to_status = 'true';
                }
                else{
                    var to_status = 'false';
                }
                $.ajax({
                    url: '/campaigns/publish/campaign/'+campaign_slug+"/"+to_status+"/",
                    type: 'GET',
                    success: function(data, textStatus, jqXHR) {
                        $('#campaignConfirmModal').modal('hide');
                        if(data['state']){
                            $("#"+campaign_slug).text('Unpublish');
                        }else{
                            $("#"+campaign_slug).text('Publish');
                        }
                    }
                }).fail(function(data, jqXHR, textStatus, errorThrown) {
                   console.log("error: ", data);
                });
             });
         });
    });
</script>
{% endblock body_scripts %}
